#!/bin/bash

mkdir -p /app/environments \
         /app/cache \
         /app/dat

cat >/app/environments/docker.yml <<EOF
---
# generated by docker
vcb:
  imgroot: ${VCB_IMAGE_ROOT:-//vault-of-cardboard.s3.amazonaws.com}
  datroot: /app/dat
  cacheroot: /app/cache

behind_proxy: yes
plugins:
  DBIC:
    default:
      dsn: dbi:SQLite:dbname=/data/vcb.db
      schema_class: VCB::DB
EOF

mkdir -p /data

export VCB_FAILSAFE_USERNAME=${VCB_FAILSAFE_USERNAME:-urza}
export VCB_FAILSAFE_PASSWORD=${VCB_FAILSAFE_PASSWORD:-'$2a$12$gVWeTxwtfA5rpM.rj3bQqO$db1ab87bed231995c2b0c275379bb3bafcd12cb4b97474'}
export DANCER_ENVIRONMENT=docker
export DANCER_ENVDIR=/app/environments
export DANCER_APPDIR=/app
export DANCER_PORT=80

cd /app
exec plackup -I/app/lib -p 80 /app/lib/app.psgi
