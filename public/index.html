<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,intial-scale=1">
<title>Vault of Cardboard</title>
<link rel="stylesheet" type="text/css" href="/css/keyrune.min.css" />
<link rel="stylesheet" type="text/css" href="/css/mana.min.css" />
<link rel="stylesheet" type="text/css" href="/css/vcb.css?v=2" />
<link rel="stylesheet" type="text/css" href="/login.css" />
</head>
<body class="signed-in">
<header>
  <h1>Vault of Cardboard</h1>
  <input name="q" placeholder="i.e.: Ral color:RU +draw" autocomplete="off">
  <nav>
    <li><a>Search</a>
        <nav>
          <li><a href="#!/docs">How do I search?</a></li>
          <li><a href="#!/sets">What sets are there?</a></li>
          <li class="separator"></li>
          <li class="if-authed"><a href="#!/q/owned">My Collection</a></li>
          <li class="if-authed"><a href="#!/q/own:2+">My Duplicates</a></li>
          <li class="if-authed"><a href="#!/q/own:4+">My Playsets</a></li>
          <li class="if-authed separator"></li>
          <li><a href="#!/q/type:planeswalker">Planeswalkers</a></li>
          <li><a href="#!/q/=mythic">Mythics</a></li>
          <li><a href="#!/q/+gains? and +loses?">Life Gain + Loss</a></li>
          <li><a href="#!/q/type:land and +damage">Pain Lands</a></li>
          <li><a href="#!/q/set:GRN">Guilds of Ravnica (GRN)</a></li>
          <li><a href="#!/q/set:DOM">Dominaria (DOM)</a></li>
          <li><a href="#!/q/set:XLN">Explorers of Ixalan (XLN)</a></li>
          <li><a href="#!/q/set:RIX">Rivals of Ixalan (RIX)</a></li>
        </nav></li>
    <li class="if-not-authed"><a href="#!/login" rel="login">Sign in</a></li>
    <li class="if-authed"><a class="-username">Member</a>
        <nav>
          <li><a href="#!/collection" rel="mycol">My Collection</a></li>
          <li><a href="#!/logout" rel="logout">Sign out</a></li>
        </nav></li>
  </nav>
</header>

<div id="main">
  <div class="landing">
    <div class="band header">
      <h1>Welcome to <span>Vault of Cardboard</span></h1>
    </div>
    <div class="band search">
      <input class="focus" name="q" autocomplete="off" placeholder=" Search the Vault...">
    </div>
    <div class="band features">
      <div><span class="i-search"></span>
           <h2>Search</h2>
           <p>The Vault has visuals for every MtG set ever printed, and a fancy
              query language to make it easier to find just the card you're after.</p>
      </div>
      <div><span class="i-track"></span>
           <h2>Track</h2>
           <p>Import your inventory into the Vault, and keep track of where your cards
              are, what decks they're in, and what you're proxying in casual.</p>
      </div>
      <div><span class="i-build"></span>
           <h2>Build</h2>
           <p>To build a strong deck, you need good cards.  Vault of Cardboard lets you
              search through printed cards based on their rules text, so you can find
              that perfect synergy.</p>
      </div>
    </div>
    <div class="band login">
      <div>
        <h1>Want an Account?</h1>
        <p>I appreciate the enthusiasm, I really do.  But right now, Vault of Cardboard is mostly a personal project that I wanted to show to a couple of friends.</p>
        <p>It's got lots of bugs.  Like, lots and <em>lots</em> of them.  Also, it's missing features.
        Also, also, when those features get implemented, <em>they</em> will have bugs.</p>
        <p>Wouldn't you rather wait until those get sussed out?</p>
        <p>Okay, alright.  If you insist, I suppose it wouldn't hurt to take down some
        contact information and drop you a line when the site goes <em>open beta</em>.</p>
        <form id="signup">
          <input type="text" name="email" placeholder=" Your Email..." /><button type="submit">&rarr;</button>
        </form>
      </div>
      <form id="login">
        <h1>Have an Account?</h1>
        <div class="oops"></div>
        <input type="text"     name="username" placeholder="username">
        <input type="password" name="password" placeholder="password">
        <button type="submit">Enter</button>
      </form>
    </div>
    <div class="band footer">
      <nav>
        <li>&copy; 2018 James Hunt</li>
      </nav>
    </div>
  </div>
  <div class="loading">
    <h1>Loading...</h1>
    <p class="marquee"></p>
  </div>
  <div class="login">
    <div class="band login">
      <div>
        <h1>Want an Account?</h1>
        <p>I appreciate the enthusiasm, I really do.  But right now, Vault of Cardboard is mostly a personal project that I wanted to show to a couple of friends.</p>
        <p>It's got lots of bugs.  Like, lots and <em>lots</em> of them.  Also, it's missing features.
        Also, also, when those features get implemented, <em>they</em> will have bugs.</p>
        <p>Wouldn't you rather wait until those get sussed out?</p>
        <p>Okay, alright.  If you insist, I suppose it wouldn't hurt to take down some
        contact information and drop you a line when the site goes <em>open beta</em>.</p>
        <form id="signup">
          <input type="text" name="email" placeholder=" Your Email..." /><button type="submit">&rarr;</button>
        </form>
      </div>
      <form id="login">
        <h1>Have an Account?</h1>
        <div class="oops"></div>
        <input type="text"     name="username" placeholder="username">
        <input type="password" name="password" placeholder="password">
        <button type="submit">Enter</button>
      </form>
    </div>
    <div class="band footer">
      <nav>
        <li>&copy; 2018 James Hunt</li>
      </nav>
    </div>
  </div>
  <div class="sets prose">
    <h1>Currently Known Magic: the Gathering Sets</h1>
    <p>These are all the M:tG sets that Vault of Cardboard knows about.
    Most of these should have images.  If a set is missing, or missing its images,
    please let us know!</p>
    <table class="sets">
      <thead><tr>
        <th></th>
        <th>Code</th>
        <th>Name</th>
        <th>Release Date</th>
        <th>Size</th>
      </tr></thead>
      <tbody>
      </tbody>
    </table>
  </div>
  <div class="docs prose">
    <h1>Vault of Cardboard Query Language</h1>
    <p>This section describes how to write queries against the Vault.</p>

    <p>The simplest of Vault queries consist of single unquoted words
    (i.e.: <kbd>counterspell</kbd>), and quoted strings (i.e.: <kbd>"Blur Sliver"</kbd>).
    These queries match cards based on their names.  The unquoted
    variety is case-insensitive, but matches whole words &mdash; <kbd>ral</kbd>
    would match <em>Ral, Caller of Storms</em>, but not <em>Baral, Chief of
    Compliance</em>.</p>

    <p>More advanced expressions exist for matching against other parts
    of the card.  For example, <kbd>color:W</kbd> is an expression that matches
    cards whose color identity includes white.</p>

    <p>Here's a list of all the expression types currently supported by
    the Vault interpreter.  Feel free to skim this list upon first
    encountering it, and then return once you get to see how
    expressions can be combined!</p>

    <table class="keywords">
      <thead><tr>
        <th>Expression</th>
        <th>How it works</th>
        <th>Example</th>
      </tr></thead>
      <tbody>
        <tr>
          <td>artist</td>
          <td>Match cards based on the name of the artist.  Art matters.</td>
          <td>artist:Poole</td>
        </tr>
        <tr>
          <td>cmc</td>
          <td>Match cards based on their converted mana cost.</td>
          <td>cmc:2+</td>
        </tr>
        <tr>
          <td>color</td>
          <td>Match cards based on their color identity.</td>
          <td>color:UR</td>
        </tr>
        <tr>
          <td>cpt</td>
          <td>Match (creature) cards based on their combined power + toughness values.</td>
          <td>cpt:&lt;4</td>
        </tr>
        <tr>
          <td>flavor</td>
          <td>Match cards based on the contents of their flavor text.</td>
          <td>flavor:Niv</td>
        </tr>
        <tr>
          <td>name</td>
          <td>Match cards based on their name.</td>
          <td>name:Bolt</td>
        </tr>
        <tr>
          <td>oracle</td>
          <td>Match cards based on the contents of their oracle text.</td>
          <td>oracle:draw</td>
        </tr>
        <tr>
          <td>own</td>
          <td>Match cards based on how many you have in your collection.</td>
          <td>own:4+</td>
        </tr>
        <tr>
          <td>power</td>
          <td>Match (creature) cards based on their power / attack value.</td>
          <td>power:2+</td>
        </tr>
        <tr>
          <td>pt</td>
          <td>Match (creature) cards based on their literal power/toughness.</td>
          <td>pt:2/3</td>
        </tr>
        <tr>
          <td>ptr</td>
          <td>Match (creature) cards based on the ratio of power:toughness.</td>
          <td>ptr:1.5+</td>
        </tr>
        <tr>
          <td>rarity</td>
          <td>Match cards based on their commonality / rarity.</td>
          <td>rarity:mythic</td>
        </tr>
        <tr>
          <td>set</td>
          <td>Match cards based on the expansion set(s) they were printed in.</td>
          <td>set:XLN</td>
        </tr>
        <tr>
          <td>toughness</td>
          <td>Match (creature) cards based on their toughness / defense value.</td>
          <td>toughness:&lt;5</td>
        </tr>
        <tr>
          <td>type</td>
          <td>Match cards based on their card type.</td>
          <td>type:land</td>
        </tr>
        <tr>
          <td>usd</td>
          <td>Match cards based on their current value/price (per Scryfall)</td>
          <td>usd:&lt;5.25</td>
        </tr>
      </tbody>
    </table>

    <p>Several of these typed expressions are so common that VCB has
    either a shorthand or keyword notation for them.</p>

    <table class="shorthand">
      <thead><tr>
        <th>Shorthand</th>
        <th>Equivalent to</th>
        <th>Example</th>
      </tr></thead>

      <tbody>
        <tr>
          <td>=X</td>
          <td>rarity:X</td>
          <td><kbd>=mythic</kbd> will find all Mythic Rares.</td>
        </tr>
        <tr>
          <td>@X</td>
          <td>color:X</td>
          <td><kbd>@WB</kbd> will find dual white/black cards.</td>
        </tr>
        <tr>
          <td>+X</td>
          <td>oracle:X</td>
          <td><kbd>+draw</kbd> finds cards that have the word "draw" in their rules text.</td>
        </tr>
        <tr>
          <td>owned</td>
          <td>own:1+</td>
          <td><kbd>owned</kbd> finds all of your cards.</td>
        </tr>
        <tr>
          <td>have</td>
          <td>own:1+</td>
          <td><kbd>have</kbd> is an alias for <kbd>owned</kbd>.</td>
        </tr>
        <tr>
          <td>need</td>
          <td>own:0</td>
          <td><kbd>need</kbd> finds all of the cards you don't own (which you clearly <strong>need</strong>).</td>
        </tr>
      </tbody>
    </table>

    <p class="note"><span>Note:</span>
    if you want to match keywords as a name, for instance if you were
    looking for <em>Hour of Need</em>, you can use the <kbd>name:</kbd> expression, as in
    <kbd>name:"Need"</kbd>.  (Due to a technical limitation that should be fixed soon,
    you do have to quote the value, which means capitalization matters!)</p>

    <p>Finally, for anything but the simplest queries, you're going to want to
    combine these expressions into larger aggregate expressions.  For these, you
    need the <em>logical operators</em>: <kbd>and</kbd>, <kbd>or</kbd>, and <kbd>not</kbd>.</p>

    <p><kbd>and</kbd> works by checking both sub-expressions; if those both match, the
    expression as a whole is a match.  <kbd>or</kbd> considers the whole expression a
    match if <em>either</em> sub-expression is a match.  This mirrors how we use the
    words "and" / "or" in English.</p>

    <p>For example, there are a lot of legendary creatures.  To build a blue / black
    commander (EDH) deck,  I need to find an interesting legendary creature who
    is both blue and black.  That's two expressions, stitched together with an
    <kbd>and</kbd>:</p>

    <pre><code class="query">type:legendary and color:UB</code></pre>

    <p>The <kbd>not</kbd> operator lets you negate an assertion.  Commander doesn't
    generally allow Planeswalkers to serve as Commanders, and since most walkers
    are listed as "Legendary Planeswalkers", I need to amend my query to
    exclude all mention of the sub-type:</p>

    <pre><code class="query">type:legendary and color:UB and not type:planeswalker</code></pre>

    <p>Much better.</p>

    <p>In the interest of reducing keystrokes, <kbd>!</kbd> is an alias of <kbd>not</kbd>; forgive
    me, this is my programmer roots showing.  A nice compact query that takes
    advantage of all this terseness is:</p>

    <pre><code class="query">owned and !=common</code></pre>

    <p>... which finds all of the uncommons, rares, and mythic rares in your
    collection.</p>

    <p>Finally, we need to talk about precedence.  Whenever you chain multiple
    <kbd>and</kbd>'s and <kbd>or</kbd>'s together, you need to consider what you actually mean.
    For example:</p>

    <pre><code class="query">owned and =rare or =mythic</code></pre>

    <p>The <em>intent</em> behind this query was to find all my rares.  Unfortunately, the
    precedence rules of the query language <em>bind</em> the <kbd>owned</kbd> and <kbd>=rare</kbd>
    sub-expressions together, and then checks the <kbd>=mythic</kbd> status.  The upshot
    is that what I actually get is all of my owned rares, and every mythic rare
    ever printed.</p>

    <p>I could reword the query to be:</p>

    <pre><code class="query">=rare or =mythic and owned</code></pre>

    <p>(in general, <kbd>and owned</kbd> on the end will almost always do what you want)</p>

    <p>Luckily, you can use parentheses to enforce the precedence you want, without
    having to reword:</p>

    <pre><code class="query">owned and (=mythic or =rare)</code></pre>

    <p>This causes the rarity expressions to be evaluated, and then checked against
    ownership status.  Just like math class!</p>

    <h2>A Query Cookbook</h2>

    <p>If you prefer to learn by doing, or just want to try some things
    out, this is the section for you.</p>

    <p><strong>What do I own from <em>Dominaria</em>?</strong></p>

    <pre><code class="query">set:DOM and owned</code></pre>

    <p><strong>What red playsets do I own?</strong> (i.e. for standard deck
    construction purposes)</p>

    <pre><code class="query">@R and own:4+</code></pre>

    <p><strong>What taplands exist?</strong></p>

    <pre><code class="query">type:Land and +tapped</code></pre>

    <p><strong>I would like to drool over Zendikar lands please</strong></p>

    <pre><code class="query">set:ZEN or set:BFZ and type:land and type:basic</code></pre>

    <p>or (if you like parentheticals (as I do)):</p>

    <pre><code class="query">(set:ZEN or set:BFZ) and (type:land and type:basic)</code></pre>

    <p><strong>Oh man do I love a good life transfer card!</strong></p>

    <pre><code class="query">+gains? and +loses?</code></pre>

    <p><strong>What white weenies have lifelink?</strong></p>

    <pre><code class="query">@W and +lifelink and pt:1/1</code></pre>

    <p><strong>What GRN creatures had more attack than defense?</strong></p>

    <pre><code class="query">set:GRN and ptr:&gt;1</code></pre>
  </div>
  <div class="edit-collection">
    <h2>My Collection</h2><form>
    <div class="oops"></div>
    <textarea name="collection"></textarea>
    <button type="submit">Save</button></form>
  </div>
  <div class="search">
    <div class="oops"></div>
    <div class="meta-results">found <span class="count">0</span> matching card(s).</div>
    <div class="grid results"></div>
  </div>
</div>


<div class="modal-bg"></div>
<div class="modal-fg"></div>

<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/lang.js"></script>
<script type="text/javascript" src="config.js"></script>
<script type="text/javascript">

function tparse(d) { // {{{
  if (typeof d == "string") {
    // because we insist on doing bad things with date formatting in the API...
    m = /^(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})$/.exec(d);
    if (!m) {
      console.log("'%s' doesn't look like a date/time string...", d);
      return ""
    }

    d = new Date();
    d.setTime(Date.UTC(parseInt(m[1]),   // year
                      parseInt(m[2])-1, // month
                      parseInt(m[3]),   // day
                      parseInt(m[4]),   // hour
                      parseInt(m[5]),   // minute
                      parseInt(m[6]))); // second
    return d;
  }

  if (!(d instanceof Date)) {
    var _d = new Date()
    if (!isNaN(d)) {
      _d.setTime(d * 1000);
    }
    return _d;
  }

  return d;
} // }}}
function strftime(fmt, d) { // {{{
  d = tparse(d);
  if (typeof(d) === 'undefined') {
    return "";
  }

  en_US = {
    pref: {
      /* %c */ datetime: function (d) { return strftime("%a %b %e %H:%M:%S %Y", d); },
      /* %x */ date:     function (d) { return strftime("%m/%d/%Y", d); },
      /* %X */ time:     function (d) { return strftime("%H:%M:%S", d); }
    },
    weekday: {
      abbr: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
      full: ['Sunday',
            'Monday',
            'Tuesday',
            'Wednesday',
            'Thursday',
            'Friday',
            'Saturday']
    },
    month: {
      abbr: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
            'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
      full: ['January',
            'February',
            'March',
            'April',
            'May',
            'June',
            'July',
            'August',
            'September',
            'October',
            'November',
            'December']
    },
    AM: "AM", am: "am", PM: "PM", pm: "pm",
    ordinal: ['th', 'st', 'nd', 'rd', 'th', 'th', 'th', 'th', 'th', 'th', 'th', //  1 - 10
                    'th', 'th', 'th', 'th', 'th', 'th', 'th', 'th', 'th', 'th', // 11 - 20
                    'st', 'nd', 'rd', 'th', 'th', 'th', 'th', 'th', 'th', 'th', // 21 - 30
                    'st'],
    zero:  ['00', '01', '02', '03', '04', '05', '06', '07', '08', '09',
            '10', '11', '12', '13', '14', '15', '16', '17', '18', '19',
            '20', '21', '22', '23', '24', '25', '26', '27', '28', '29',
            '30', '31', '32', '33', '34', '35', '36', '37', '38', '39',
            '40', '41', '42', '43', '44', '45', '46', '47', '48', '49',
            '50', '51', '52', '53', '54', '55', '56', '57', '58', '59'],

    space: [' 0', ' 1', ' 2', ' 3', ' 4', ' 5', ' 6', ' 7', ' 8', ' 9',
            '10', '11', '12', '13', '14', '15', '16', '17', '18', '19',
            '20', '21', '22', '23', '24', '25', '26', '27', '28', '29',
            '30', '31', '32', '33', '34', '35', '36', '37', '38', '39',
            '40', '41', '42', '43', '44', '45', '46', '47', '48', '49',
            '50', '51', '52', '53', '54', '55', '56', '57', '58', '59'],
  };

  var lc = en_US;

  var inspec = false;
  var alt_o  = false;

  var s = '';
  for (var i = 0; i < fmt.length; i++) {
    var c = fmt.charCodeAt(i);
    if (inspec) {
      switch (c) {
      // %%   A literal '%' character
      case 37:
        s += '%';
        break;

      // %a   The abbreviated name of the day of the week according to the
      //      current locale.
      case 97:
        s += lc.weekday.abbr[d.getDay()];
        break;

      // %A   The full name of the day of the week according to the current
      //      locale.
      case 65:
        s += lc.weekday.full[d.getDay()];
        break;

      // %b   The abbreviated month name according to the current locale.
      case 98:
        s += lc.month.abbr[d.getMonth()];
        break;

      // %h   Equivalent to %b.
      case 104:
        s += lc.month.abbr[d.getMonth()];
        break;

      // %B   The full month name according to the current locale.
      case 66:
        s += lc.month.full[d.getMonth()];
        break;

      // %c   The preferred date and time representation for the current
      //      locale.
      case 99:
        s += lc.pref.datetime(d);
        break;

      // %C   The century number (year/100) as a 2-digit integer
      case 67:
        s += d.getFullYear() / 100;
        break;

      // %d   The day of the month as a decimal number (range 01 to 31).
      case 100:
        s += lc.zero[d.getDate()];
        break;

      // %D   Equivalent to %m/%d/%y.  (Yecch—for Americans only.  Americans
      //      should note that in other countries %d/%m/%y is rather common.
      //      This means that in international context this format is
      //      ambiguous and should not be used.)
      case 68:
        s += strftime("%m/%d/%y", d);
        break;

      // %e   Like %d, the day of the month as a decimal number, but a
      //      leading zero is replaced by a space.
      case 101:
        s += d.getDate().toString()+(alt_o ? lc.ordinal[d.getDate()] : '');
        break;

      // %E   Modifier: use alternative format, see below.
      case 69:
        // not supported; just skip it
        continue;

      // %F   Equivalent to %Y-%m-%d (the ISO 8601 date format).
      case 70:
        s += strftime("%Y-%m-%d", d);
        break;

      // %G   The ISO 8601 week-based year (see NOTES) with century as a
      //      decimal number.  The 4-digit year corresponding to the ISO
      //      week number (see %V).  This has the same format and value as
      //      %Y, except that if the ISO week number belongs to the previous
      //      or next year, that year is used instead.
      case 71:
        throw "this strftime() does not support '%G'"; // FIXME

      // %g   Like %G, but without century, that is, with a 2-digit year
      //      (00-99).
      case 103:
        throw "this strftime() does not support '%g'"; // FIXME

      // %H   The hour as a decimal number using a 24-hour clock (range 00 to 23).
      case 72:
        s += lc.zero[d.getHours()]
        break;

      // %I   The hour as a decimal number using a 12-hour clock (range 01 to 12)
      case 73:
        s += lc.zero[d.getHours() % 12 == 0 ? 12 : d.getHours() % 12];
        break;

      // %j   The day of the year as a decimal number (range 001 to 366).
      case 106:
        throw "this strftime() does not support '%j'"; // FIXME

      // %k   The hour (24-hour clock) as a decimal number (range 0 to 23);
      //      single digits are preceded by a blank.  (See also %H.)
      case 107:
        s += lc.space[d.getHours()];
        break;

      // %l   The hour (12-hour clock) as a decimal number (range 1 to 12);
      //      single digits are preceded by a blank.  (See also %I.)
      case 108:
        s += lc.space[d.getHours() % 12 == 0 ? 12 : d.getHours() % 12];
        break;

      // %m   The month as a decimal number (range 01 to 12).
      case 109:
        s += lc.zero[d.getMonth()+1];
        break;

      // %M   The minute as a decimal number (range 00 to 59).
      case 77:
        s += lc.zero[d.getMinutes()];
        break;

      // %n   A newline character.
      case 110:
        s += "\n";
        break;

      // %O   Modifier: use alternative format, see below.
      case 79:
        alt_o = true;
        continue;

      // %p   Either "AM" or "PM" according to the given time value, or the
      //      corresponding strings for the current locale.  Noon is treated
      //      as "PM" and midnight as "AM".
      case 112:
        s += (d.getHours() < 12 ? lc.AM : lc.PM);
        break;

      // %P   Like %p but in lowercase: "am" or "pm" or a corresponding
      //      string for the current locale.
      case 80:
        s += (d.getHours() < 12 ? lc.am : lc.pm);
        break;

      // %r   The time in a.m. or p.m. notation.  In the POSIX locale this
      //      is equivalent to %I:%M:%S %p.
      case 114:
        s += lc.zero[d.getHours() % 12 == 0 ? 12 : d.getHours() % 12] + ":" +
            lc.zero[d.getMinutes()]                                  + ":" +
            lc.zero[d.getSeconds()]                                  + " " +
            (d.getHours() < 12 ? lc.AM : lc.PM);
        break;

      // %R   The time in 24-hour notation (%H:%M).  For a version
      //      including the seconds, see %T below.
      case 82:
        s += lc.zero[d.getHours()] + ":" +
            lc.zero[d.getMinutes()];
        break;

      // %s   The number of seconds since the Epoch,
      //      1970-01-01 00:00:00+0000 (UTC).
      case 115:
        s += d.getTime().toString();
        break;

      // %S   The second as a decimal number (range 00 to 60).  (The range
      //      is up to 60 to allow for occasional leap seconds.)
      case 83:
        s += lc.zero[d.getSeconds()];
        break;

      // %t   A tab character.
      case 116:
        s += "\t";
        break;

      // %T   The time in 24-hour notation (%H:%M:%S).
      case 84:
        s += lc.zero[d.getHours()]   + ":" +
            lc.zero[d.getMinutes()] + ":" +
            lc.zero[d.getSeconds()];
        break;

      // %u   The day of the week as a decimal, range 1 to 7, Monday being 1.
      //       See also %w.
      case 117:
        s += (d.getDay()+1).toString()+(alt_o ? lc.ordinal[d.getDay()+1] : '');
        break;

      // %U   The week number of the current year as a decimal number, range
      //      00 to 53, starting with the first Sunday as the first day of
      //      week 01.  See also %V and %W.
      case 85:
        throw "this strftime() does not support '%U'"; // FIXME

      // %V   The ISO 8601 week number (see NOTES) of the current year as a
      //      decimal number, range 01 to 53, where week 1 is the first week
      //      that has at least 4 days in the new year.  See also %U and %W.
      case 86:
        throw "this strftime() does not support '%V'"; // FIXME

      // %w   The day of the week as a decimal, range 0 to 6, Sunday being 0
      //      See also %u.
      case 119:
        s += (d.getDay()).toString();
        break;

      // %W   The week number of the current year as a decimal number, range
      //      00 to 53, starting with the first Monday as the first day of
      //      week 01.
      case 87:
        throw "this strftime() does not support '%W'"; // FIXME

      // %x   The preferred date representation for the current locale
      //      without the time.
      case 120:
        s += lc.pref.date(d);
        break;

      // %X   The preferred time representation for the current locale
      //      without the date.
      case 88:
        s += lc.pref.time(d);
        break;

      // %y   The year as a decimal number without a century (range 00 to 99).
      case 121:
        s += lc.zero[d.getFullYear() % 100];
        break;

      // %Y   The year as a decimal number including the century.
      case 89:
        s += d.getFullYear();
        break;

      // %z   The +hhmm or -hhmm numeric timezone (that is, the hour and
      //      minute offset from UTC).
      case 122:
        throw "this strftime() does not support '%z'"; // FIXME

      // %Z   The timezone name or abbreviation.
      case 90:
        throw "this strftime() does not support '%Z'"; // FIXME

      default:
        throw "unrecognized strftime sequence '%"+fmt[i]+"'";
      }

      inspec = false;
      alt_o  = false;
      continue;
    }

    if (c == 37) { // %
      inspec = true
      continue;
    }

    s += fmt[i];
  }
  return s;
} // }}}

function dated(yyyymmdd, unknown) {
  yyyymmdd = yyyymmdd.toString();
  if (yyyymmdd.length == 4) { yyyymmdd += '0101'; }
  if (yyyymmdd.length == 6) { yyyymmdd +=   '01'; }
  if (yyyymmdd.length != 8) { return unknown; }

  var dd   =  yyyymmdd                        % 100;
  var mm   = (yyyymmdd -          dd) /   100 % 100;
  var yyyy = (yyyymmdd - mm*100 - dd) / 10000;
  console.log("[%s]; yyyy = %d; mm = %d; dd = %d", yyyymmdd, yyyy, mm, dd);
  return new Date(yyyy, mm-1, dd);
}
function cardface(card) {
  var alt = card.name + ' [' + card.set.code + ']';
  return '<span class="card face">'+
    '<img data-id="'+card.id+'" src="'+$CONFIG.imgroot+'/cards/'+card.image+'" alt="'+alt+'" title="'+alt+'">'+
  '</span>';
}

function cardback() {
  return '<span class="card back"><img src="/mtgback.jpg"></span>';
}

function colorize(s) {
  var c = s.split("");
  for (var i = 0; i < c.length; i++) {
    c[i] = '<span class="ms ms-'+c[i].toLowerCase()+' ms-cost"></span>';
  }
  return c.join('');
}

$(function () {
  var $BASE  = undefined,
      $CARDS = undefined,
      $SETS  = undefined,
      $INDEX = {};

  console.log('retrieving personal details...');
  $.ajax({
    type: 'GET',
    url:  '/v/whoami',
    success: function (data) {
      if (data.id) {
        $('.-username').html(data.display);
        $(document.body).attr('data-user-id', data.id);
      }
    }
  });

  var $ONCARD = undefined;
  console.log('retrieving full card set data (/cards.json)...');
  $.ajax({
    type: 'GET',
    url:  '/cards.json',
    success: function (data) {
      console.log('card data retrieved successfully!');

      $BASE  = data;
      $INDEX = {};

      console.log('indexing cards...');
      for (var set in $BASE) {
        for (var i = 0; i < $BASE[set].length; i++) {
          $BASE[set][i].owned = 0;
          $INDEX[$BASE[set][i].id] = $BASE[set][i];
        }
      }
      console.log('indexing complete!');

      if ($ONCARD) {
        console.log('chaining to the oncard function...');
        var fn = $ONCARD;
        $ONCARD = undefined;
        fn.call();
      }
    }
  });

  var $ONSET = undefined;
  console.log('retrieving full set data (/sets.json)...');
  $.ajax({
    type: 'GET',
    url:  '/sets.json',
    success: function (data) {
      console.log('set data retrieved successfully!');

      $SETS = data;
      if ($ONSET) {
        console.log('chaining to the onset function...');
        var fn = $ONSET;
        $ONSET = undefined;
        fn.call();
      }
    }
  });

  function search(q) {
    console.log('triggering search handler...');
    if (q) {
      $('input[name=q]').val(q).trigger('change');
    } else {
      $('input[name=q]').trigger('change');
    }
  }

  function refreshCollection(then) {
    console.log('attempting to refresh collection...');

    $.ajax({
      type: 'GET',
      url:  '/my/collection.json',
      success: function (cards) {
        if (cards.error) {
          console.log('/my/collection.json failed: %s', cards.error);
          return;
        }

        $CARDS = $BASE;
        $INDEX = {};

        console.log('indexing cards (against collection)...');
        for (var set in $CARDS) {
          for (var i = 0; i < $CARDS[set].length; i++) {
            $CARDS[set][i].owned = 0;
            if (set in cards && $CARDS[set][i].name in cards[set]) {
              $CARDS[set][i].owned = cards[set][$CARDS[set][i].name];
            }
            $INDEX[$CARDS[set][i].id] = $CARDS[set][i];
          }
        }

        if (then) {
          console.log('chain-executing post-search callback function...');
          then.call();
        }
      }
    });
  }

  function loadertain() {
    var msg = [
      /* flavor:canto or flavor:"Song" */
      /* Arbor Armament (DOM) */
      "<blockquote>&ldquo;Llanowar's boughs are ever ready<br>To unleash an autumn of steel leaves.&rdquo;<cite>&mdash;&ldquo;Song of Freyalise&rdquo;</cite></blockquote>",

      /* Blinding Light (MIR) */
      "<blockquote>&ldquo;My shield will bear a shining sun so you will always be with me. / Inlaid with gold, it will shine like glowing embers.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

      /* Chariot of the Sun (MIR) */
      "<blockquote>&ldquo;Sun follows Moon until she tires, then carries her until she's strong / and runs ahead of him again.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

      /* Congregate (A25) */
      "<blockquote>&ldquo;In the gathering there is strength for all who founder, renewal for all who languish, love for all who sing.&rdquo;<cite>&mdash;Song of All, canto 642</cite></blockquote>",

      /* Defensive Formation (USG) */
      "<blockquote>&ldquo;Your enemies will pound upon the door of your defenses, but only you shall have the key, and it is the key of life.&rdquo;<cite>&mdash;Song of All, canto 873</cite></blockquote>",

      /* Disenchant (A25) */
      "<blockquote>&ldquo;The tools of evil are mere things. And like all things, they cannot last forever.&rdquo;<cite>&mdash;Song of All, canto 881</cite></blockquote>",

      /* Early Harvest (MIR) */
      "<blockquote>&ldquo;Tonight we'll eat a farewell feast. Cold corn porridge is not enough. / Let's peel papayas, pineapples, and mangoes, drink coconut milk, / and bake bananas.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

      /* Femeref Knight (MIR) */
      "<blockquote>&ldquo;I will return / with lizard skins for your sandals. Paint your eyes black and wait for me.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

      /* Flare (MIR) */
      "<blockquote>&ldquo;In the forest, fires light the sky as black clouds unfold their weight.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

      /* Invoke the Divine (DOM) */
      "<blockquote>&ldquo;Let go of all that harms you. Cast your burdens into the darkness, and build for the faithful a house of light.&rdquo;<cite>&mdash;Song of All, canto 1008</cite></blockquote>",

      /* Kukemssa Pirates (MIR) */
      "<blockquote>&ldquo;. . . pirates gambled with a djinn and lost the thing more dear than gold.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

      /* On Serra's Wings (DOM) */
      "<blockquote>&ldquo;The spirit of Serra raised Brindri high and commanded her to keep the balance.&rdquo;<cite>&mdash;Song of All, canto 524</cite></blockquote>",

      /* Pegasus Charger (USG) */
      "<blockquote>&ldquo;The clouds came alive and dove to the earth! Hooves flashed among the dark army, who fled before the spectacle of fury.&rdquo;<cite>&mdash;Song of All, canto 211</cite></blockquote>",

      /* Planar Birth (USG) */
      "<blockquote>&ldquo;From womb of nothingness sprang this place of beauty, purity, and hope realized.&rdquo;<cite>&mdash;Song of All, canto 3</cite></blockquote>",

      /* Sacred Mesa (MIR) */
      "<blockquote>&ldquo;Do not go there, do not go / unless you rise on wings, unless you walk on hooves.&rdquo;<cite>&mdash;&ldquo;Song to the Sun,&rdquo; Femeref song</cite></blockquote>",

      /* Serra Avenger (TSP) */
      "<blockquote>&ldquo;Those who endure in the face of suffering, those whose faith shines long in evil days, they shall see salvation.&rdquo;<cite>&mdash;Song of All, canto 904</cite></blockquote>",

      /* Serra's Embrace (USG) */
      "<blockquote>&ldquo;Lifted beyond herself, for that battle Brindri was an angel of light and fury.&rdquo;<cite>&mdash;Song of All, canto 524</cite></blockquote>",

      /* Unfulfilled Desires (MIR) */
      "<blockquote>&ldquo;Like Day from Night, / I'll live my life apart from you, just glimpsing you across the sky, / because you cannot change, my dear, and nor can I.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

      /* Village Elder (MIR) */
      "<blockquote>&ldquo;Enchant me with your tale-telling. Tell about Tree, Grass, River, and Wind. / Tell why Truth must fight with Falsehood, and why Truth will always win.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

      /* Voice of Grace (USG) */
      "<blockquote>&ldquo;Opposite Law is Grace, and Grace must be preserved. If the strands of Grace are unraveled, its design will be lost, and the people with it.&rdquo;<cite>&mdash;Song of All, canto 167</cite></blockquote>",

      /* Voice of Law (USG) */
      "<blockquote>&ldquo;Life's balance is as a star: on one point is Law, and Law must be upheld. If the knots of order are loosened, chaos will spill through.&rdquo;<cite>&mdash;Song of All, canto 167</cite></blockquote>",

      /* Wild Elephant (MIR) */
      "<blockquote>&ldquo;I will tell my father's stories . . . . How the elephants trampled the leopard cub, and its father, though he knew, killed nine goats instead.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

      /* Wildgrowth Walker (XLN) */
      "<blockquote>&ldquo;Hear me, stone, root, branch: be the fist of this land. Turn back those who trample upon your domain.&rdquo;<cite>&mdash;Song of the Shaper</cite></blockquote>",

      /* Zebra Unicorn (MIR) */
      "<blockquote>&ldquo;I'll capture gentle zebras / for your steeds and fill the stable with every kind of unicorn.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

      /* Zhalfirin Knight (MIR) */
      "<blockquote>&ldquo;You returned a warrior. . . . Your hair was cut, your eye tattooed with the red triangle of war.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>"

    ];

    var on = false
    var marquee = function () {
      if (!$(document.body).is('.loading')) {
        on = false;
        return;
      }
      var $m = $('.loading .marquee');
      console.log('firing marquee (on = %s)', on);
      if (on) {
        $m.fadeOut();
        on = !on;
        window.setTimeout(marquee, 800);
      } else {
        $m.html($(msg[parseInt(Math.random() * msg.length)])).fadeIn();
        on = !on;
        window.setTimeout(marquee, 7700);
      }
    };
    marquee();
  }

  function switchTo(page) {
    $(document.body).attr('class', '').addClass(page).addClass('i'+parseInt(Math.random() * (275 - 250) + 250).toString());
    loadertain();
  }
  switchTo('landing');
  $('.focus').focus();

  function goto(sub) {
    console.log('nav to ['+sub+']');
    if (sub == "sets") {
      var thunk = function () {
        var $t = $('#main > .sets table tbody');
        $t.empty();
        $.each($SETS, function (i, e) {
          $t.append($('<tr>'+
              '<td><span class="ss ss-'+e.code.toLowerCase()+'"></span></td>'+
              '<td>'+e.code+'</td>'+
              '<td>'+e.name+'</td>'+
              '<td data-sort="'+e.release+'">'+strftime("%B %Oe, %Y", dated(e.release))+'</td>'+
              '<td><a href="#!/q/set:'+e.code+'">'+e.size+'</a></td>'+
            '</tr>'));
        });
      };
      if (!$SETS) {
        $ONSET = thunk;
      } else {
        thunk();
      }
    }

    switchTo(sub.replace(/\/.*/, ''));

    if (sub == "logout") {
      $.ajax({
        type: 'POST',
        url:  '/v/logout',
        complete: function () {
          document.cookie = 'vcb_sesh=; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
          document.location.href = document.location.href.replace(/#.*/, '');
        }
      });
      return;
    }

    if (sub.match(/^q\/./)) {
      console.log(sub, sub.replace(/^q\//, ""));
      var q = decodeURIComponent(sub.replace(/^q\//, ''));
      $('input[name="q"]').val(q);
      console.log('search requested, for (%s)', q);
      if (!$BASE) {
        console.log('BASE collection not yet loaded; registering $ONCARD event handler...');
        $ONCARD = function () {
          console.log('$ONCARD handler fired... refreshing collection and then proceeded with search for %s', q);
          refreshCollection(function () { search(q); });
        };
        switchTo('loading');
        return;
      }

      switchTo('search');
      if (!$CARDS) { $CARDS = $BASE; }

      $('.results').empty();
      $('.meta-results').css({ visibility: 'hidden' });
      $('.oops').hide();

      var query, n = 50000;
      try {
        query = Query.parse(q);
      } catch (e) {
        $('.search .oops').html(q+': '+e.toString()).fadeIn();
        return;
      }

      var found = [];
      for (var set in $CARDS) {
        for (var i = 0; i < $CARDS[set].length; i++) {
          var card = $CARDS[set][i];
          if (query.match(card)) {
            found.push(card);
            n--;
            if (n == 0) { break; }
          }
        }
        if (n == 0) { break; }
      }
      found = found.sort(function (a, b) {
        if (a.name > b.name) { return 1; }
        if (a.name < b.name) { return -1; }
        return 0;
      });
      var max = 400;
      for (var i = 0; i < found.length && i < max; i++) {
        $('.results').append('<span data-own="'+found[i].owned.toString()+'">'+
                                cardback()+cardface(found[i])+
                             '</span>');
      }
      $('.meta-results .count').html(found.length);
      $('.meta-results').css({ visibility: 'visible' });
      return;
    }
  }

  $(window).on('hashchange', function (event) {
    if (document.location.hash.match(/^#!/)) {
      goto(document.location.hash.replace(/^#!\/?/, ''));
    }
  }).trigger('hashchange');

  $(document.body)
  .on('submit', 'form#login', function (event) {
    event.preventDefault();
    var $f = $(event.target);
    $('.oops').hide();

    $.ajax({
      type: 'POST',
      url:  '/v/login',
      data: JSON.stringify({
        username: $f.find('[name=username]').val(),
        password: $f.find('[name=password]').val()
      }),
      success: function (data) {
        if (data.ok) {
          document.cookie = 'vcb_sesh='+data.user.session+';max-age=7776000;samesite=strict';
          $(document.body).attr('data-user-id', data.user.id);
          $('.-username').html(data.user.display);
          refreshCollection();
          switchTo('search');

        } else if (data.error) {
          $('.login .oops').html(data.error).fadeIn();

        } else {
          $('.login .oops').html("Uh-oh, something broke pretty bad.  Tap "+colorize("2UUU")+" and summon James, Fixer of Codes!").fadeIn();
        }
      }
    });
  })
  .on('click', 'a[rel="mycol"]', function (event) {
    event.preventDefault();
    switchTo('loading');
    $.ajax({
      type: 'GET',
      url:  '/my/collection.vcb',
      success: function (data) {
        $('.edit-collection textarea').val(data);
        switchTo('edit');
      }
    });
  })
  .on('submit', '.edit-collection form', function (event) {
    event.preventDefault();
    $('.oops').hide();

    $.ajax({
      type: 'PUT',
      url:  '/my/collection',
      data: JSON.stringify({ vcb: $(event.target).find('textarea').val() }),
      success: function (data) {
        if (data.ok) {
          refreshCollection(function () { search("owned") });
        } else if (data.error) {
          var $oops = $('.edit-collection .oops');
          if (data.errors) {
            var ul = $('<ul>');
            if (data.errors.length > 10) {
              for (var i = 0; i < 5; i++) {
                ul.append($('<li>'+data.errors[i]+'</li>'));
              }
              ul.append($('<li><a href="#more">see remaining '+(data.errors.length - 5).toString()+' issues...</a></li>'));
              for (var i = 5; i < data.errors.length; i++) {
                ul.append($('<li class="suppress">'+data.errors[i]+'</li>'));
              }
            } else {
              for (var i = 0; i < data.errors.length; i++) {
                ul.append($('<li>'+data.errors[i]+'</li>'));
              }
            }
            $oops.empty().append(data.error);
            $oops.append(ul).fadeIn();
          } else {
            $oops.html(data.error).fadeIn();
          }
        } else {
          $('.edit-collection .oops').html("Uh-oh, something broke pretty bad.  Tap "+colorize("4BR")+" to cast James Legendary Bug Fix").fadeIn(); }
      }
    });
  })
  .on('change', 'input[name="q"]', function (event) {
    event.preventDefault();
    var q = $(event.target).val();
    $('input[name="q"]').each(function (i,e) { $(e).val(q); });
    var dest = '#!/q/'+encodeURIComponent(q);
    if (document.location.hash == dest) {
      $(window).trigger('hashchange');
    } else {
      document.location.hash = dest;
    }
  })
  .on('click', '.results .face img', function (event) {
    var id   = $(event.target).closest('[data-id]').attr('data-id'),
        card = $INDEX[id];

    var quotify = function (name, set, s) {
      s = s || '';
      while (s.match('"')) {
        s = s.replace('"', '&ldquo;').replace('"', '&rdquo;');
      }
      s = s.replace(/&/g, '&amp;').replace(/ *â/, '&lt;cite&gt;&amp;mdash;');
      if (s.match(';cite')) {
        s += '&lt;/cite&gt;';
      }
      return '/* '+name+' ('+set.code+') */'+"\n\n\"&lt;blockquote&gt;"+s+"&lt;/blockquote&gt;\"";
    };

    $('.modal-fg').empty().append(
      '<img src="'+$(event.target).closest('img').attr('src')+'">'+
      '<div class="detail">'+
        '<a class="close" href="#">X</a>'+
            '<ul class="tags">'+
              '<li>tag</li>'+
              '<li>control</li>'+
            '</ul>'+
            '<ul class="info">'+
              '<li><strong>'+card.name+'</strong></li>'+
              '<li><em>'+card.type.replace(/\xe2\x80\x94/g, '-')+'</em></li>'+
              '<li>'+card.set.name+' ('+card.set.code+')</li>'+
              '<li>#'+card.number+'/'+card.set.total+'</li>'+
              '<li>'+colorize(card.color)+'</li>'+
              '<li><strong>CMC:</strong> '+card.cmc+'</li>'+
              '<li>'+card.rarity+'</li>'+
            '</ul>'+
            '<textarea style="display: none">'+quotify(card.name, card.set, card.flavor)+'</textarea>'+
            '<ul class="owned">'+
              '<li><strong>Owned:</strong> '+card.owned.toString()+'</li>'+
              /*'<li><strong>Proxied:</strong> 1</li>'+*/
            '</ul>'+
            /*'<ul class="where">'+
              '<li>1 in <a href="#">Niv-Mizzet →</a></li>'+
              '<li>1 in <a href="#">ctl60 →</a></li>'+
              '<li>1 in <a href="#">Collection →</a></li>'+
            '</ul>'+*/
            '<ul>'+
              '<li class="oracle"><p>'+card.oracle.replace(/\xe2\x88\x92/g, '-').replace(/\n/g, '</p><p>')+'</p></li>'+
            '</ul>'+
            '<p class="price">$'+card.price+'</p>'+
          '</div>'+
      '</div>');
    $('.modal-bg, .modal-fg').show();
  })
  .on('click', '.oops ul a[href="#more"]', function (event) {
    event.preventDefault();
    $(event.target).closest('ul').find('li.suppress').show();
    $(event.target).closest('li').hide();
  })
  .on('click', '.modal-fg a.close', function (event) {
    event.preventDefault();
    $('.modal-bg, .modal-fg').hide();
  })
});
</script>
</body>
</html>
