<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Vault of Cardboard</title>
<link rel="stylesheet" type="text/css" href="/css/keyrune.min.css" />
<link rel="stylesheet" type="text/css" href="/css/mana.min.css" />
<link rel="stylesheet" type="text/css" href="/css/vcb.css?v=1" />
<link rel="stylesheet" type="text/css" href="/login.css" />
</head>
<body>
<header>
  <h1>Vault of Cardboard</h1>
  <input name="q" placeholder="i.e.: Ral color:RU +draw" autocomplete="off">
  <nav>
    <li><a href="" rel="mycol">Import</a></li>
    <li>Search
        <nav>
          <li><a href="q:owned">My Collection</a></li>
          <li><a href="q:own:2+">My Duplicates</a></li>
          <li><a href="q:own:4+">My Playsets</a></li>
          <li><a href="q:type:planeswalker">Planeswalkers</a></li>
          <li><a href="q:=mythic">Mythics</a></li>
          <li><a href="q:+gains? and +loses?">Life Gain + Loss</a></li>
          <li><a href="q:type:land and +damage">Pain Lands</a></li>
          <li><a href="q:set:GRN">Guilds of Ravnica (GRN)</a></li>
          <li><a href="q:set:DOM">Dominaria (DOM)</a></li>
          <li><a href="q:set:XLN">Explorers of Ixalan (XLN)</a></li>
          <li><a href="q:set:RIX">Rivals of Ixalan (RIX)</a></li>
        </nav></li>
  </nav>
</header>

<div id="main">
  <div class="landing">
  </div>
  <div class="loading">
    <h1>Loading...</h1>
    <p class="marquee"></p>
  </div>
  <div class="login">
    <div><form>
      <h2>Welcome to the Vault</h2>
      <div class="oops"></div>
      <p><label for="username">Account</label>
      <input type="text" name="username"></p>
      <p><label for="password">Password</label>
      <input type="password" name="password"></p>
      <button type="submit">Enter</button></form>
    </div>
  </div>
  <div class="edit-collection">
    <h2>My Collection</h2><form>
    <div class="oops"></div>
    <textarea name="collection"></textarea>
    <button type="submit">Save</button></form>
  </div>
  <div class="search">
    <div class="oops"></div>
    <div class="meta-results">found <span class="count">0</span> matching card(s).</div>
    <div class="grid results"></div>
  </div>
</div>


<div class="modal-bg"></div>
<div class="modal-fg"></div>

<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/lang.js"></script>
<script type="text/javascript" src="config.js"></script>
<script type="text/javascript">

function cardface(card) {
  var alt = card.name + ' [' + card.set.code + ']';
  return '<span class="card face">'+
    '<img data-id="'+card.id+'" src="'+$CONFIG.imgroot+'/cards/'+card.image+'" alt="'+alt+'" title="'+alt+'">'+
  '</span>';
}

function cardback() {
  return '<span class="card back"><img src="/mtgback.jpg"></span>';
}

function colorize(s) {
  var c = s.split("");
  for (var i = 0; i < c.length; i++) {
    c[i] = '<span class="ms ms-'+c[i].toLowerCase()+' ms-cost"></span>';
  }
  return c.join('');
}

$(function () {
  var $BASE  = undefined,
      $CARDS = undefined,
      $INDEX = {};

  var $ONCARD = undefined;
  console.log('retrieving full card set data (/cards.json)...');
  $.ajax({
    type: 'GET',
    url:  '/cards.json',
    success: function (data) {
      console.log('card set data retrieved successfully!');

      $BASE  = data;
      $INDEX = {};

      console.log('indexing cards...');
      for (var set in $BASE) {
        for (var i = 0; i < $BASE[set].length; i++) {
          $BASE[set][i].owned = 0;
          $INDEX[$BASE[set][i].id] = $BASE[set][i];
        }
      }
      console.log('indexing complete!');

      if ($ONCARD) {
        console.log('chaining to the oncard function...');
        var fn = $ONCARD;
        $ONCARD = undefined;
        fn.call();
      }
    }
  });

  function search(q) {
    console.log('triggering search handler...');
    if (q) {
      $('input[name=q]').val(q).trigger('change');
    } else {
      $('input[name=q]').trigger('change');
    }
  }

  function refreshCollection(then) {
    console.log('attempting to refresh collection...');

    $.ajax({
      type: 'GET',
      url:  '/my/collection.json',
      success: function (cards) {
        if (cards.error) {
          console.log('/my/collection.json failed: %s', cards.error);
          return;
        }

        $CARDS = $BASE;
        $INDEX = {};

        console.log('indexing cards (against collection)...');
        for (var set in $CARDS) {
          for (var i = 0; i < $CARDS[set].length; i++) {
            $CARDS[set][i].owned = 0;
            if (set in cards && $CARDS[set][i].name in cards[set]) {
              $CARDS[set][i].owned = cards[set][$CARDS[set][i].name];
            }
            $INDEX[$CARDS[set][i].id] = $CARDS[set][i];
          }
        }

        if (then) {
          console.log('chain-executing post-search callback function...');
          then.call();
        }
      }
    });
  }

  function loadertain() {
    var msg = [
      /* flavor:canto or flavor:"Song" */
      /* Arbor Armament (DOM) */
      "<blockquote>&ldquo;Llanowar's boughs are ever ready<br>To unleash an autumn of steel leaves.&rdquo;<cite>&mdash;&ldquo;Song of Freyalise&rdquo;</cite></blockquote>",

      /* Blinding Light (MIR) */
      "<blockquote>&ldquo;My shield will bear a shining sun so you will always be with me. / Inlaid with gold, it will shine like glowing embers.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

      /* Chariot of the Sun (MIR) */
      "<blockquote>&ldquo;Sun follows Moon until she tires, then carries her until she's strong / and runs ahead of him again.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

      /* Congregate (A25) */
      "<blockquote>&ldquo;In the gathering there is strength for all who founder, renewal for all who languish, love for all who sing.&rdquo;<cite>&mdash;Song of All, canto 642</cite></blockquote>",

      /* Defensive Formation (USG) */
      "<blockquote>&ldquo;Your enemies will pound upon the door of your defenses, but only you shall have the key, and it is the key of life.&rdquo;<cite>&mdash;Song of All, canto 873</cite></blockquote>",

      /* Disenchant (A25) */
      "<blockquote>&ldquo;The tools of evil are mere things. And like all things, they cannot last forever.&rdquo;<cite>&mdash;Song of All, canto 881</cite></blockquote>",

      /* Early Harvest (MIR) */
      "<blockquote>&ldquo;Tonight we'll eat a farewell feast. Cold corn porridge is not enough. / Let's peel papayas, pineapples, and mangoes, drink coconut milk, / and bake bananas.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

      /* Femeref Knight (MIR) */
      "<blockquote>&ldquo;I will return / with lizard skins for your sandals. Paint your eyes black and wait for me.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

      /* Flare (MIR) */
      "<blockquote>&ldquo;In the forest, fires light the sky as black clouds unfold their weight.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

      /* Invoke the Divine (DOM) */
      "<blockquote>&ldquo;Let go of all that harms you. Cast your burdens into the darkness, and build for the faithful a house of light.&rdquo;<cite>&mdash;Song of All, canto 1008</cite></blockquote>",

      /* Kukemssa Pirates (MIR) */
      "<blockquote>&ldquo;. . . pirates gambled with a djinn and lost the thing more dear than gold.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

      /* On Serra's Wings (DOM) */
      "<blockquote>&ldquo;The spirit of Serra raised Brindri high and commanded her to keep the balance.&rdquo;<cite>&mdash;Song of All, canto 524</cite></blockquote>",

      /* Pegasus Charger (USG) */
      "<blockquote>&ldquo;The clouds came alive and dove to the earth! Hooves flashed among the dark army, who fled before the spectacle of fury.&rdquo;<cite>&mdash;Song of All, canto 211</cite></blockquote>",

      /* Planar Birth (USG) */
      "<blockquote>&ldquo;From womb of nothingness sprang this place of beauty, purity, and hope realized.&rdquo;<cite>&mdash;Song of All, canto 3</cite></blockquote>",

      /* Sacred Mesa (MIR) */
      "<blockquote>&ldquo;Do not go there, do not go / unless you rise on wings, unless you walk on hooves.&rdquo;<cite>&mdash;&ldquo;Song to the Sun,&rdquo; Femeref song</cite></blockquote>",

      /* Serra Avenger (TSP) */
      "<blockquote>&ldquo;Those who endure in the face of suffering, those whose faith shines long in evil days, they shall see salvation.&rdquo;<cite>&mdash;Song of All, canto 904</cite></blockquote>",

      /* Serra's Embrace (USG) */
      "<blockquote>&ldquo;Lifted beyond herself, for that battle Brindri was an angel of light and fury.&rdquo;<cite>&mdash;Song of All, canto 524</cite></blockquote>",

      /* Unfulfilled Desires (MIR) */
      "<blockquote>&ldquo;Like Day from Night, / I'll live my life apart from you, just glimpsing you across the sky, / because you cannot change, my dear, and nor can I.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

      /* Village Elder (MIR) */
      "<blockquote>&ldquo;Enchant me with your tale-telling. Tell about Tree, Grass, River, and Wind. / Tell why Truth must fight with Falsehood, and why Truth will always win.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

      /* Voice of Grace (USG) */
      "<blockquote>&ldquo;Opposite Law is Grace, and Grace must be preserved. If the strands of Grace are unraveled, its design will be lost, and the people with it.&rdquo;<cite>&mdash;Song of All, canto 167</cite></blockquote>",

      /* Voice of Law (USG) */
      "<blockquote>&ldquo;Life's balance is as a star: on one point is Law, and Law must be upheld. If the knots of order are loosened, chaos will spill through.&rdquo;<cite>&mdash;Song of All, canto 167</cite></blockquote>",

      /* Wild Elephant (MIR) */
      "<blockquote>&ldquo;I will tell my father's stories . . . . How the elephants trampled the leopard cub, and its father, though he knew, killed nine goats instead.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

      /* Wildgrowth Walker (XLN) */
      "<blockquote>&ldquo;Hear me, stone, root, branch: be the fist of this land. Turn back those who trample upon your domain.&rdquo;<cite>&mdash;Song of the Shaper</cite></blockquote>",

      /* Zebra Unicorn (MIR) */
      "<blockquote>&ldquo;I'll capture gentle zebras / for your steeds and fill the stable with every kind of unicorn.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>",

      /* Zhalfirin Knight (MIR) */
      "<blockquote>&ldquo;You returned a warrior. . . . Your hair was cut, your eye tattooed with the red triangle of war.&rdquo;<cite>&mdash;&ldquo;Love Song of Night and Day&rdquo;</cite></blockquote>"

    ];

    var on = false
    var marquee = function () {
      if (!$(document.body).is('.loading')) {
        on = false;
        return;
      }
      var $m = $('.loading .marquee');
      console.log('firing marquee (on = %s)', on);
      if (on) {
        $m.fadeOut();
        on = !on;
        window.setTimeout(marquee, 800);
      } else {
        $m.html($(msg[parseInt(Math.random() * msg.length)])).fadeIn();
        on = !on;
        window.setTimeout(marquee, 7700);
      }
    };
    marquee();
  }

  function switchTo(page) {
    $(document.body).attr('class', '').addClass(page).addClass('i'+parseInt(Math.random() * (275 - 250) + 250).toString());
    loadertain();
  }
  switchTo('login');

  $(document.body)
  .on('click', '.login button', function (event) {
    event.preventDefault();
    var $f = $(event.target).closest('.login');
    $('.oops').hide();

    $.ajax({
      type: 'POST',
      url:  '/v/login',
      data: JSON.stringify({
        username: $f.find('[name=username]').val(),
        password: $f.find('[name=password]').val()
      }),
      success: function (data) {
        if (data.ok) {
          document.cookie = 'vcb_sesh='+data.user.session+';max-age=7776000;samesite=strict';
          refreshCollection();
          switchTo('search');

        } else if (data.error) {
          $('.login .oops').html(data.error).fadeIn();

        } else {
          $('.login .oops').html("Uh-oh, something broke pretty bad.  Tap "+colorize("2UUU")+" and summon James, Fixer of Codes!").fadeIn();
        }
      }
    });
  })
  .on('click', 'a[rel="mycol"]', function (event) {
    event.preventDefault();
    switchTo('loading');
    $.ajax({
      type: 'GET',
      url:  '/my/collection.vcb',
      success: function (data) {
        $('.edit-collection textarea').val(data);
        switchTo('edit');
      }
    });
  })
  .on('submit', '.edit-collection form', function (event) {
    event.preventDefault();
    $('.oops').hide();

    $.ajax({
      type: 'PUT',
      url:  '/my/collection',
      data: JSON.stringify({ vcb: $(event.target).find('textarea').val() }),
      success: function (data) {
        if (data.ok) {
          refreshCollection(function () { search("owned") });
        } else if (data.error) {
          var $oops = $('.edit-collection .oops');
          if (data.errors) {
            var ul = $('<ul>');
            if (data.errors.length > 10) {
              for (var i = 0; i < 5; i++) {
                ul.append($('<li>'+data.errors[i]+'</li>'));
              }
              ul.append($('<li><a href="#more">see remaining '+(data.errors.length - 5).toString()+' issues...</a></li>'));
              for (var i = 5; i < data.errors.length; i++) {
                ul.append($('<li class="suppress">'+data.errors[i]+'</li>'));
              }
            } else {
              for (var i = 0; i < data.errors.length; i++) {
                ul.append($('<li>'+data.errors[i]+'</li>'));
              }
            }
            $oops.empty().append(data.error);
            $oops.append(ul).fadeIn();
          } else {
            $oops.html(data.error).fadeIn();
          }
        } else {
          $('.edit-collection .oops').html("Uh-oh, something broke pretty bad.  Tap "+colorize("4BR")+" to cast James Legendary Bug Fix").fadeIn(); }
      }
    });
  })
  .on('change', 'input[name="q"]', function (event) {
    event.preventDefault();
    console.log('search requested, for (%s)', q);
    if (!$BASE) {
      console.log('BASE collection not yet loaded; registering $ONCARD event handler...');
      $ONCARD = function () {
        console.log('$ONCARD handler fired... refreshing collection and then proceeded with search for %s', q);
        refreshCollection(function () { search(q); });
      };
      switchTo('loading');
      return;
    }

    switchTo('search');
    if (!$CARDS) { $CARDS = $BASE; }

    $('.results').empty();
    $('.meta-results').css({ visibility: 'hidden' });
    $('.oops').hide();

    var q, n = 50000;
    try {
      q = Query.parse($(event.target).val());
    } catch (e) {
      $('.search .oops').html($(event.target).val()+': '+e.toString()).fadeIn();
      return;
    }

    var found = [];
    for (var set in $CARDS) {
      for (var i = 0; i < $CARDS[set].length; i++) {
        var card = $CARDS[set][i];
        if (q.match(card)) {
          found.push(card);
          n--;
          if (n == 0) { break; }
        }
      }
      if (n == 0) { break; }
    }
    found = found.sort(function (a, b) {
      if (a.name > b.name) { return 1; }
      if (a.name < b.name) { return -1; }
      return 0;
    });
    var max = 400;
    for (var i = 0; i < found.length && i < max; i++) {
      $('.results').append('<span data-own="'+found[i].owned.toString()+'">'+
                              cardback()+cardface(found[i])+
                           '</span>');
    }
    $('.meta-results .count').html(found.length);
    $('.meta-results').css({ visibility: 'visible' });
  })
  .on('click', '.results .face img', function (event) {
    var id   = $(event.target).closest('[data-id]').attr('data-id'),
        card = $INDEX[id];

    var quotify = function (name, set, s) {
      s = s || '';
      while (s.match('"')) {
        s = s.replace('"', '&ldquo;').replace('"', '&rdquo;');
      }
      s = s.replace(/&/g, '&amp;').replace(/ *â/, '&lt;cite&gt;&amp;mdash;');
      if (s.match(';cite')) {
        s += '&lt;/cite&gt;';
      }
      return '/* '+name+' ('+set.code+') */'+"\n\n\"&lt;blockquote&gt;"+s+"&lt;/blockquote&gt;\"";
    };

    $('.modal-fg').empty().append(
      '<img src="'+$(event.target).closest('img').attr('src')+'">'+
      '<div class="detail">'+
        '<a class="close" href="#">X</a>'+
            '<ul class="tags">'+
              '<li>tag</li>'+
              '<li>control</li>'+
            '</ul>'+
            '<ul class="info">'+
              '<li>#'+card.number+'/'+card.set.total+'</li>'+
              '<li>'+colorize(card.color)+'</li>'+
              '<li><strong>CMC:</strong> '+card.cmc+'</li>'+
              '<li>'+card.rarity+'</li>'+
            '</ul>'+
            '<textarea style="display: none">'+quotify(card.name, card.set, card.flavor)+'</textarea>'+
            '<ul class="owned">'+
              '<li><strong>Owned:</strong> '+card.owned.toString()+'</li>'+
              /*'<li><strong>Proxied:</strong> 1</li>'+*/
            '</ul>'+
            /*'<ul class="where">'+
              '<li>1 in <a href="#">Niv-Mizzet →</a></li>'+
              '<li>1 in <a href="#">ctl60 →</a></li>'+
              '<li>1 in <a href="#">Collection →</a></li>'+
            '</ul>'+*/
            '<p class="price">$'+card.price+'</p>'+
          '</div>'+
      '</div>');
    $('.modal-bg, .modal-fg').show();
  })
  .on('click', '.oops ul a[href="#more"]', function (event) {
    event.preventDefault();
    $(event.target).closest('ul').find('li.suppress').show();
    $(event.target).closest('li').hide();
  })
  .on('click', '.modal-fg a.close', function (event) {
    event.preventDefault();
    $('.modal-bg, .modal-fg').hide();
  })
  .on('click', '[href^="q:"]', function (event) {
    event.preventDefault();
    search($(event.target).closest('[href^="q:"]').attr('href').replace(/^q:/, ''));
  });
});
</script>
</body>
</html>
